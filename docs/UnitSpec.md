# Unit Spec: <기능명 또는 API 이름>

## 1. 요구사항 요약

- **목적:** <무엇을 하기 위한 기능인지 한 줄 요약>
- **유형:** ☐ 신규 ☐ 변경 ☐ 삭제
- **핵심 요구사항:**
  - 입력: <예: topic, userId 등>
  - 출력: <예: markdown, json, status code 등>
  - 예외/제약: <예: 토픽 누락 시 400 반환, 타임아웃 15s>
  - 처리흐름 요약: <한 줄로 동작 요약>

---

## 2. 구현 대상 파일

| 구분 | 경로                                    | 설명                  |
| ---- | --------------------------------------- | --------------------- |
| 신규 | backend/app/api/v1/report_controller.py | 신규 API 엔드포인트   |
| 변경 | backend/app/services/report_service.py  | 보고서 생성 로직 수정 |
| 참조 | backend/app/clients/llm_client.py       | LLM 호출 구조 참고    |

---

## 3. 동작 플로우 (Mermaid)

```mermaid
flowchart TD
    A[Client] -->|POST /api/v1/report| B(API)
    B --> C[ReportService.generate()]
    C --> D{Cache Hit?}
    D -- No --> E[LLM Client: callClaude()]
    E --> F[Convert Markdown → HWPX]
    F --> G[Save to DB]
    G --> H[Return JSON Response]
```

---

## 4. 테스트 계획

### 4.1 원칙

- **테스트 우선(TDD)**: 본 섹션의 항목을 우선 구현하고 코드 작성.
- **계층별 커버리지**: Unit → Integration → API(E2E-lite) 순서로 최소 P0 커버.
- **독립성/재현성**: 외부 연동(LLM/DB/File I/O)은 모킹 또는 임베디드 스토리지 사용.
- **판정 기준**: 기대 상태코드/스키마/부작용(저장/로그)을 명시적으로 검증.

### 4.2 구현 예상 테스트 항목(각 항목의 목적 포함)

| TC ID      | 계층 | 시나리오              | 목적(무엇을 검증?)                 | 입력/사전조건                        | 기대결과                                           |
| ---------- | ---- | --------------------- | ---------------------------------- | ------------------------------------ | -------------------------------------------------- |
| TC-API-001 | API  | 보고서 생성 성공      | API 계약/상태코드/응답 스키마 검증 | `POST /api/v1/report` `{topic:"AI"}` | `201`, `markdown` 필드 존재, 스키마 스냅샷 일치    |
| TC-API-002 | API  | 입력 누락(Validation) | 입력 검증 및 오류 매핑             | `{}`                                 | `400`, 에러코드 `VALIDATION_ERROR`, 메시지 키 존재 |
| TC-API-003 | API  | 비정상 타입           | 스키마 검증 강제 및 방어 로직      | `{topic: 123}`                       | `400`, 상세 사유 포함                              |
| TC-SVC-004 | Unit | 캐시 히트 경로        | 캐시 우선 반환·LLM 미호출          | 캐시에 동일 토픽 결과 존재           | LLM 호출 0회, 기존 값 반환                         |
| TC-SVC-005 | Unit | 캐시 미스 → LLM 호출  | LLM 호출 트리거/후처리/검증        | 캐시 미스, LLM 목 성공               | 정규식으로 마크다운 형식 간단 검증, 후처리 호출됨  |

### 4.3 샘플 테스트 코드

테스트 작성가이드 `backend/BACKEND_TEST.md`

---

## 5. 사용자 요청 프롬프트

**⚠️ 중요:** 이 섹션은 **대화 흐름 전체**를 기록합니다. 초기 요청부터 최종 명확화까지 모든 단계를 포함하세요.

### 5.1 단계별 기록 방식

#### 1단계: 초기 사용자 요청
```
사용자가 제시한 원본 요청 (요구사항, 시나리오, 제약사항 등)
```

#### 2단계: Claude 응답 (필요시)
```
Claude가 제시한 추가 고려사항, 질문, 제안사항
또는 "추가 고려사항을 분석하여 제시" 등으로 요약 가능
```

#### 3단계: 사용자 명확화/수정
```
사용자의 재요청, 명확화, 수정 내용
(예: 보안사항 추가, 제약사항 변경, 도구 지정 등)
```

#### 4단계: 최종 통합 정리
```
모든 명확화를 통합한 최종 요구사항 체크리스트
(체크표시로 최종 합의 사항 표시)
```

### 5.2 기록 템플릿

**Original User Request (1차):**

```
<사용자 1차 요청>
```

**Claude 응답 (필요시):**
```
<Claude 분석/제안 또는 설명>
```

**User Clarification/Modification (2차+):**

```
<사용자 추가 요청/명확화>
```

**최종 명확화 (통합):**
- ✅ <확정된 사항 1>
- ✅ <확정된 사항 2>
- ✅ <확정된 사항 3>

---

**요청 일시:** YYYY-MM-DD

**컨텍스트/배경:**
- <사용자가 제공한 컨텍스트>
- <관련 이슈, 참고사항>

---

### 5.3 기록 방식 팁

| 상황 | 기록 방법 |
|------|---------|
| 초기 요청만 있는 경우 | "Original User Request" 섹션만 작성 |
| Claude가 고려사항 분석한 경우 | "Claude 응답" 섹션 추가 |
| 사용자가 명확화한 경우 | "User Clarification" 섹션 추가 |
| 여러 번 왕복한 경우 | 시간순 또는 단계순으로 기록 (1차, 2차, 3차...) |
| 모든 내용이 확정된 경우 | "최종 명확화 (통합)" 섹션에 체크리스트 형태로 정리 |

---

**Note:** 이 섹션은 요구사항의 원본 출처와 **결정 과정**을 보존하여:
- 구현 과정에서 의도를 재확인할 수 있도록
- 향후 변경 요청 시 초기 요구사항과의 차이를 추적할 수 있도록
- 팀원들이 결정 배경을 이해할 수 있도록
하기 위한 목적입니다.
