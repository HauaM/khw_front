<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>상담 등록 - KWH 지식관리시스템</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&amp;family=Roboto+Mono:wght@400;600&amp;display=swap"
      rel="stylesheet"
    />
    <script src="/_sdk/element_sdk.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans KR", "Apple SD Gothic Neo", system-ui,
          -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: #212121;
        background-color: #fafafa;
        box-sizing: border-box;
        height: 100%;
        width: 100%;
      }

      html {
        height: 100%;
        width: 100%;
      }

      /* App Header */
      .app-header {
        height: 60px;
        background-color: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
      }

      .app-header-left {
        display: flex;
        flex-direction: column;
      }

      .app-title {
        font-size: 18px;
        font-weight: 700;
        color: #005bac;
        line-height: 1.2;
      }

      .app-subtitle {
        font-size: 12px;
        color: #6e6e6e;
        margin-top: 2px;
      }

      .app-header-right {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: #424242;
      }

      .header-divider {
        color: #bdbdbd;
      }

      /* Main Container */
      .main-container {
        padding-top: 60px;
        height: 100%;
        width: 100%;
        overflow-y: auto;
      }

      .content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 24px;
      }

      /* Page Header */
      .page-header {
        margin-bottom: 24px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 700;
        color: #212121;
        margin-bottom: 8px;
      }

      .page-description {
        font-size: 14px;
        color: #6e6e6e;
      }

      /* Form Container */
      .form-container {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.08);
        padding: 32px;
      }

      /* Form Section */
      .form-section {
        margin-bottom: 32px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .form-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #212121;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
      }

      /* Form Grid */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .form-grid.full-width {
        grid-template-columns: 1fr;
      }

      /* Form Group */
      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 13px;
        font-weight: 600;
        color: #212121;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .form-label.required::after {
        content: "*";
        color: #c62828;
        font-size: 14px;
      }

      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        min-height: 36px;
        border: 1px solid #bdbdbd;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.2);
      }

      .form-input.error,
      .form-textarea.error,
      .form-select.error {
        border-color: #c62828;
      }

      .form-textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
      }

      .form-helper {
        font-size: 12px;
        color: #6e6e6e;
        margin-top: 4px;
      }

      .form-error {
        font-size: 12px;
        color: #c62828;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .form-error svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }

      /* Typeahead Select */
      .typeahead-container {
        position: relative;
      }

      .typeahead-input {
        cursor: pointer;
        padding-right: 36px;
      }

      .typeahead-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: #6e6e6e;
        pointer-events: none;
        transition: transform 0.2s;
      }

      .typeahead-container.open .typeahead-icon {
        transform: translateY(-50%) rotate(180deg);
      }

      .typeahead-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background-color: #ffffff;
        border: 1px solid #bdbdbd;
        border-radius: 4px;
        box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.08);
        max-height: 240px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .typeahead-container.open .typeahead-dropdown {
        display: block;
      }

      .typeahead-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .typeahead-item:hover {
        background-color: #e8f1fb;
      }

      .typeahead-item.selected {
        color: #005bac;
        font-weight: 600;
      }

      .typeahead-item.add-new {
        border-top: 1px solid #e0e0e0;
        color: #005bac;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .typeahead-item.add-new:hover {
        background-color: #e8f1fb;
      }

      .typeahead-item.add-new svg {
        width: 18px;
        height: 18px;
      }

      .typeahead-empty {
        padding: 16px 12px;
        text-align: center;
        color: #6e6e6e;
        font-size: 13px;
      }

      /* Metadata Fields */
      .metadata-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .metadata-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 12px;
        align-items: start;
      }

      .metadata-input {
        width: 100%;
        min-height: 36px;
        border: 1px solid #bdbdbd;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 14px;
        font-family: inherit;
      }

      .metadata-input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.2);
      }

      .metadata-remove-btn {
        width: 36px;
        height: 36px;
        border: 1px solid #bdbdbd;
        border-radius: 4px;
        background-color: #ffffff;
        color: #c62828;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .metadata-remove-btn:hover {
        background-color: #ffebee;
        border-color: #c62828;
      }

      .metadata-remove-btn svg {
        width: 18px;
        height: 18px;
      }

      .metadata-add-btn {
        height: 36px;
        padding: 0 16px;
        border: 1px solid #005bac;
        border-radius: 4px;
        background-color: #ffffff;
        color: #005bac;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .metadata-add-btn:hover {
        background-color: #e8f1fb;
      }

      .metadata-add-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Form Actions */
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e0e0e0;
      }

      .btn {
        height: 40px;
        padding: 0 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-secondary {
        background-color: #ffffff;
        color: #424242;
        border: 1px solid #bdbdbd;
      }

      .btn-secondary:hover {
        background-color: #f5f5f5;
      }

      .btn-primary {
        background-color: #005bac;
        color: #ffffff;
        border: none;
      }

      .btn-primary:hover {
        background-color: #00437f;
      }

      .btn-primary:disabled {
        background-color: #bdbdbd;
        cursor: not-allowed;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
      }

      .modal {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 500px;
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #212121;
      }

      .modal-body {
        padding: 24px;
      }

      .modal-body p {
        font-size: 14px;
        color: #424242;
        line-height: 1.6;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      /* Add Code Modal */
      .add-code-modal .modal {
        max-width: 600px;
      }

      /* Toast */
      .toast {
        position: fixed;
        top: 80px;
        right: 24px;
        background-color: #ffffff;
        border-radius: 6px;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 3000;
        animation: slideIn 0.3s ease-out;
        min-width: 320px;
      }

      .toast.success {
        border-left: 4px solid #2e7d32;
      }

      .toast.error {
        border-left: 4px solid #c62828;
      }

      .toast-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .toast-message {
        font-size: 14px;
        color: #212121;
        flex: 1;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  </head>
  <body>
    <!-- App Header -->
    <header class="app-header">
      <div class="app-header-left">
        <div class="app-title" id="headerTitle">KWH 지식관리시스템</div>
        <div class="app-subtitle">Kwangju Bank Help Desk Wiki</div>
      </div>
      <div class="app-header-right">
        <span id="headerDepartment">디지털전략부</span>
        <span class="header-divider">·</span>
        <span id="headerUserName">홍길동</span>
      </div>
    </header>
    <!-- Main Container -->
    <main class="main-container">
      <div class="content-wrapper">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title" id="pageTitle">상담 등록</h1>
          <p class="page-description">고객 상담 내용을 입력하고 저장합니다.</p>
        </div>
        <!-- Form Container -->
        <div class="form-container">
          <form id="consultationForm">
            <!-- Basic Information Section -->
            <div class="form-section">
              <h2 class="form-section-title">기본 정보</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label required">요청영업점</label>
                  <input
                    type="text"
                    class="form-input"
                    id="branchCode"
                    placeholder="영업점 코드를 입력하세요"
                  />
                  <div class="form-error hidden" id="branchCodeError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>요청영업점을 입력하세요.</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label required">요청직원</label>
                  <input
                    type="text"
                    class="form-input"
                    id="employeeId"
                    placeholder="직원 ID를 입력하세요"
                  />
                  <div class="form-error hidden" id="employeeIdError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>요청직원을 입력하세요.</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label required">화면번호</label>
                  <input
                    type="text"
                    class="form-input"
                    id="screenId"
                    placeholder="예: SCR001"
                  />
                  <div class="form-error hidden" id="screenIdError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>화면번호를 입력하세요.</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label required">거래명</label>
                  <input
                    type="text"
                    class="form-input"
                    id="transactionName"
                    placeholder="거래명을 입력하세요"
                  />
                  <div class="form-error hidden" id="transactionNameError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>거래명을 입력하세요.</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Classification Section -->
            <div class="form-section">
              <h2 class="form-section-title">분류 정보</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label required">업무구분</label>
                  <div class="typeahead-container" id="businessTypeContainer">
                    <input
                      type="text"
                      class="form-input typeahead-input"
                      id="businessType"
                      placeholder="업무구분을 검색하거나 선택하세요"
                      autocomplete="off"
                    />
                    <svg
                      class="typeahead-icon"
                      fill="none"
                      stroke="currentColor"
                      viewbox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                    <div class="typeahead-dropdown" id="businessTypeDropdown">
                      <!-- Options will be rendered here -->
                    </div>
                  </div>
                  <div class="form-error hidden" id="businessTypeError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>업무구분을 선택하세요.</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label required">에러코드</label>
                  <div class="typeahead-container" id="errorCodeContainer">
                    <input
                      type="text"
                      class="form-input typeahead-input"
                      id="errorCode"
                      placeholder="에러코드를 검색하거나 선택하세요"
                      autocomplete="off"
                    />
                    <svg
                      class="typeahead-icon"
                      fill="none"
                      stroke="currentColor"
                      viewbox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                    <div class="typeahead-dropdown" id="errorCodeDropdown">
                      <!-- Options will be rendered here -->
                    </div>
                  </div>
                  <div class="form-error hidden" id="errorCodeError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>에러코드를 선택하세요.</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Content Section -->
            <div class="form-section">
              <h2 class="form-section-title">상담 내용</h2>
              <div class="form-grid full-width">
                <div class="form-group full-width">
                  <label class="form-label required">문의내용</label>
                  <textarea
                    class="form-textarea"
                    id="inquiryText"
                    placeholder="고객의 문의내용을 자세히 입력하세요"
                    rows="5"
                  ></textarea>
                  <div class="form-error hidden" id="inquiryTextError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>문의내용을 입력하세요.</span>
                  </div>
                </div>
                <div class="form-group full-width">
                  <label class="form-label required">조치내용</label>
                  <textarea
                    class="form-textarea"
                    id="actionTaken"
                    placeholder="문제 해결을 위해 수행한 조치내용을 입력하세요"
                    rows="5"
                  ></textarea>
                  <div class="form-error hidden" id="actionTakenError">
                    <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    ><span>조치내용을 입력하세요.</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Metadata Section -->
            <div class="form-section">
              <h2 class="form-section-title">추가 정보 (선택)</h2>
              <div class="form-group">
                <label class="form-label">메타데이터 필드</label>
                <div class="form-helper">
                  상담과 관련된 추가 정보를 Key/Value 형태로 입력할 수 있습니다.
                </div>
                <div class="metadata-container" id="metadataContainer">
                  <!-- Metadata rows will be rendered here -->
                </div>
                <button
                  type="button"
                  class="metadata-add-btn"
                  id="addMetadataBtn"
                >
                  <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                  필드 추가
                </button>
              </div>
            </div>
            <!-- Form Actions -->
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="cancelBtn">
                취소
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  viewbox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                저장
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
    <!-- Create Manual Modal -->
    <div id="createManualModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">메뉴얼 생성</h3>
        </div>
        <div class="modal-body">
          <p>상담 내용이 성공적으로 저장되었습니다.</p>
          <p style="margin-top: 12px">
            이 상담 내용을 기반으로 메뉴얼을 생성하시겠습니까?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="manualModalNo">
            나중에
          </button>
          <button type="button" class="btn btn-primary" id="manualModalYes">
            메뉴얼 생성
          </button>
        </div>
      </div>
    </div>
    <!-- Add New Code Modal -->
    <div id="addCodeModal" class="modal-overlay hidden add-code-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title" id="addCodeModalTitle">새 업무구분 추가</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label required">코드 이름 (Label)</label>
            <input
              type="text"
              class="form-input"
              id="newCodeLabel"
              placeholder="예: 특수여신"
            />
          </div>
          <div class="form-group" style="margin-top: 16px">
            <label class="form-label required">코드 값 (Code)</label>
            <input
              type="text"
              class="form-input"
              id="newCodeValue"
              placeholder="예: SPECIAL_LOAN"
            />
            <div class="form-helper">
              영문 대문자와 언더스코어(_)만 사용하세요.
            </div>
          </div>
          <div class="form-group" style="margin-top: 16px">
            <label class="form-label">설명</label>
            <textarea
              class="form-textarea"
              id="newCodeDescription"
              placeholder="코드에 대한 설명을 입력하세요"
              rows="3"
            ></textarea>
          </div>
          <div
            class="form-error hidden"
            id="addCodeError"
            style="margin-top: 12px"
          >
            <svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              /></svg
            ><span id="addCodeErrorMessage">코드 생성에 실패했습니다.</span>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            id="addCodeModalCancel"
          >
            취소
          </button>
          <button type="button" class="btn btn-primary" id="addCodeModalSave">
            저장
          </button>
        </div>
      </div>
    </div>
    <script>
      // Sample Data - Common Codes
      const commonCodes = {
        BUSINESS_TYPE: [
          { code: "DEPOSIT", label: "예금", description: "예금 관련 업무" },
          { code: "LOAN", label: "대출", description: "대출 관련 업무" },
          { code: "CARD", label: "카드", description: "카드 관련 업무" },
          { code: "INVESTMENT", label: "투자", description: "투자 관련 업무" },
          { code: "EXCHANGE", label: "환전", description: "환전 관련 업무" },
        ],
        ERROR_CODE: [
          {
            code: "ERR_001",
            label: "네트워크 오류",
            description: "서버 연결 실패",
          },
          {
            code: "ERR_002",
            label: "권한 오류",
            description: "접근 권한 없음",
          },
          {
            code: "ERR_003",
            label: "데이터 오류",
            description: "입력 데이터 형식 오류",
          },
          { code: "ERR_004", label: "타임아웃", description: "응답 시간 초과" },
          {
            code: "ERR_005",
            label: "시스템 오류",
            description: "내부 서버 오류",
          },
        ],
      };

      // State
      let selectedBusinessType = null;
      let selectedErrorCode = null;
      let metadataFields = [];
      let currentAddCodeType = null; // 'BUSINESS_TYPE' or 'ERROR_CODE'
      let savedConsultationId = null;

      // Default Config
      const defaultConfig = {
        system_title: "KWH 지식관리시스템",
        page_title: "상담 등록",
        user_name: "홍길동",
        department: "디지털전략부",
      };

      let config = { ...defaultConfig };

      // Typeahead Component
      class Typeahead {
        constructor(
          containerId,
          dropdownId,
          inputId,
          codeType,
          allowCreate = true
        ) {
          this.container = document.getElementById(containerId);
          this.dropdown = document.getElementById(dropdownId);
          this.input = document.getElementById(inputId);
          this.codeType = codeType;
          this.allowCreate = allowCreate;
          this.selectedValue = null;
          this.filteredOptions = [];

          this.init();
        }

        init() {
          // Input events
          this.input.addEventListener("click", () => this.open());
          this.input.addEventListener("input", (e) =>
            this.filter(e.target.value)
          );

          // Click outside to close
          document.addEventListener("click", (e) => {
            if (!this.container.contains(e.target)) {
              this.close();
            }
          });

          // Keyboard navigation
          this.input.addEventListener("keydown", (e) => this.handleKeyboard(e));
        }

        open() {
          this.container.classList.add("open");
          this.render(commonCodes[this.codeType]);
        }

        close() {
          this.container.classList.remove("open");
        }

        filter(searchTerm) {
          const filtered = commonCodes[this.codeType].filter(
            (item) =>
              item.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
              item.label.toLowerCase().includes(searchTerm.toLowerCase())
          );
          this.render(filtered, searchTerm);
        }

        render(options, searchTerm = "") {
          this.filteredOptions = options;
          let html = "";

          if (options.length === 0) {
            html = `
            <div class="typeahead-empty">
              일치하는 코드가 없습니다.<br>
              <span style="font-size: 12px; color: #9E9E9E;">필요 시 관리자에게 코드 등록을 요청하세요.</span>
            </div>
          `;
          } else {
            html = options
              .map(
                (item) => `
            <div class="typeahead-item ${
              this.selectedValue === item.code ? "selected" : ""
            }" data-code="${item.code}">
              <div style="font-weight: 600;">${item.label}</div>
              <div style="font-size: 12px; color: #6E6E6E;">${item.code}</div>
            </div>
          `
              )
              .join("");
          }

          // Add "Create New" option if allowCreate is true and searchTerm is not empty
          if (this.allowCreate && searchTerm.trim() !== "") {
            const groupLabel =
              this.codeType === "BUSINESS_TYPE" ? "업무구분" : "에러코드";
            html += `
            <div class="typeahead-item add-new" data-action="create">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              <span>새 ${groupLabel} 추가: "${searchTerm}"</span>
            </div>
          `;
          }

          this.dropdown.innerHTML = html;

          // Add click handlers
          this.dropdown
            .querySelectorAll(".typeahead-item[data-code]")
            .forEach((item) => {
              item.addEventListener("click", () => {
                const code = item.dataset.code;
                this.select(code);
              });
            });

          // Add "Create New" handler
          const createBtn = this.dropdown.querySelector(
            '.typeahead-item[data-action="create"]'
          );
          if (createBtn) {
            createBtn.addEventListener("click", () => {
              this.openCreateModal(searchTerm);
            });
          }
        }

        select(code) {
          const option = commonCodes[this.codeType].find(
            (item) => item.code === code
          );
          if (option) {
            this.selectedValue = code;
            this.input.value = option.label;

            // Update global state
            if (this.codeType === "BUSINESS_TYPE") {
              selectedBusinessType = code;
            } else if (this.codeType === "ERROR_CODE") {
              selectedErrorCode = code;
            }

            this.close();

            // Remove error if exists
            const errorElement = document.getElementById(
              this.input.id + "Error"
            );
            if (errorElement) {
              errorElement.classList.add("hidden");
              this.input.classList.remove("error");
            }
          }
        }

        openCreateModal(searchTerm) {
          currentAddCodeType = this.codeType;
          const groupLabel =
            this.codeType === "BUSINESS_TYPE" ? "업무구분" : "에러코드";

          document.getElementById(
            "addCodeModalTitle"
          ).textContent = `새 ${groupLabel} 추가`;
          document.getElementById("newCodeLabel").value = searchTerm;
          document.getElementById("newCodeValue").value = "";
          document.getElementById("newCodeDescription").value = "";
          document.getElementById("addCodeError").classList.add("hidden");

          document.getElementById("addCodeModal").classList.remove("hidden");
          this.close();
        }

        handleKeyboard(e) {
          // TODO: Implement keyboard navigation (↑/↓/Enter)
        }

        getValue() {
          return this.selectedValue;
        }

        reset() {
          this.selectedValue = null;
          this.input.value = "";
        }
      }

      // Initialize Typeaheads
      const businessTypeahead = new Typeahead(
        "businessTypeContainer",
        "businessTypeDropdown",
        "businessType",
        "BUSINESS_TYPE",
        true
      );

      const errorCodeTypeahead = new Typeahead(
        "errorCodeContainer",
        "errorCodeDropdown",
        "errorCode",
        "ERROR_CODE",
        true
      );

      // Metadata Functions
      function addMetadataField() {
        const id = Date.now();
        metadataFields.push({ id, key: "", value: "" });
        renderMetadataFields();
      }

      function removeMetadataField(id) {
        metadataFields = metadataFields.filter((field) => field.id !== id);
        renderMetadataFields();
      }

      function renderMetadataFields() {
        const container = document.getElementById("metadataContainer");

        if (metadataFields.length === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = metadataFields
          .map(
            (field) => `
        <div class="metadata-row" data-id="${field.id}">
          <input 
            type="text" 
            class="metadata-input" 
            placeholder="Key (예: customer_id)" 
            value="${field.key}"
            data-field="key"
            data-id="${field.id}"
          >
          <input 
            type="text" 
            class="metadata-input" 
            placeholder="Value (예: 12345)" 
            value="${field.value}"
            data-field="value"
            data-id="${field.id}"
          >
          <button type="button" class="metadata-remove-btn" data-id="${field.id}">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `
          )
          .join("");

        // Add event listeners
        container.querySelectorAll(".metadata-input").forEach((input) => {
          input.addEventListener("input", (e) => {
            const id = parseInt(e.target.dataset.id);
            const field = e.target.dataset.field;
            const fieldObj = metadataFields.find((f) => f.id === id);
            if (fieldObj) {
              fieldObj[field] = e.target.value;
            }
          });
        });

        container.querySelectorAll(".metadata-remove-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.dataset.id);
            removeMetadataField(id);
          });
        });
      }

      // Form Validation
      function validateForm() {
        let isValid = true;
        const fields = [
          { id: "branchCode", name: "요청영업점" },
          { id: "employeeId", name: "요청직원" },
          { id: "screenId", name: "화면번호" },
          { id: "transactionName", name: "거래명" },
          { id: "inquiryText", name: "문의내용" },
          { id: "actionTaken", name: "조치내용" },
        ];

        // Clear all errors first
        fields.forEach((field) => {
          const input = document.getElementById(field.id);
          const error = document.getElementById(field.id + "Error");
          input.classList.remove("error");
          error.classList.add("hidden");
        });

        // Validate text fields
        fields.forEach((field) => {
          const input = document.getElementById(field.id);
          const error = document.getElementById(field.id + "Error");

          if (!input.value.trim()) {
            input.classList.add("error");
            error.classList.remove("hidden");
            isValid = false;
          }
        });

        // Validate business type
        if (!selectedBusinessType) {
          const input = document.getElementById("businessType");
          const error = document.getElementById("businessTypeError");
          input.classList.add("error");
          error.classList.remove("hidden");
          isValid = false;
        }

        // Validate error code
        if (!selectedErrorCode) {
          const input = document.getElementById("errorCode");
          const error = document.getElementById("errorCodeError");
          input.classList.add("error");
          error.classList.remove("hidden");
          isValid = false;
        }

        return isValid;
      }

      // Form Submission
      async function handleSubmit(e) {
        e.preventDefault();

        if (!validateForm()) {
          showToast("필수 항목을 모두 입력해주세요.", "error");
          return;
        }

        // Prepare metadata object
        const metadata = {};
        metadataFields.forEach((field) => {
          if (field.key.trim() !== "") {
            metadata[field.key] = field.value;
          }
        });

        const formData = {
          branch_code: document.getElementById("branchCode").value.trim(),
          employee_id: document.getElementById("employeeId").value.trim(),
          screen_id: document.getElementById("screenId").value.trim(),
          transaction_name: document
            .getElementById("transactionName")
            .value.trim(),
          business_type: selectedBusinessType,
          error_code: selectedErrorCode,
          inquiry_text: document.getElementById("inquiryText").value.trim(),
          action_taken: document.getElementById("actionTaken").value.trim(),
          metadata_fields: Object.keys(metadata).length > 0 ? metadata : null,
        };

        // Disable submit button
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        저장 중...
      `;

        try {
          // TODO: API Call - POST /consultations
          // const response = await fetch('/api/consultations', {
          //   method: 'POST',
          //   headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify(formData)
          // });
          //
          // if (!response.ok) {
          //   throw new Error('Failed to save consultation');
          // }
          //
          // const result = await response.json();
          // savedConsultationId = result.id;

          // Simulate API call
          await new Promise((resolve) => setTimeout(resolve, 1000));
          savedConsultationId = Math.floor(Math.random() * 10000);

          showToast("상담 내용이 성공적으로 저장되었습니다.", "success");

          // Show manual creation modal
          setTimeout(() => {
            document
              .getElementById("createManualModal")
              .classList.remove("hidden");
          }, 500);
        } catch (error) {
          console.error("Error saving consultation:", error);
          showToast("저장에 실패했습니다. 다시 시도해주세요.", "error");
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = `
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          저장
        `;
        }
      }

      // Add New Code
      async function handleAddCode() {
        const label = document.getElementById("newCodeLabel").value.trim();
        const code = document.getElementById("newCodeValue").value.trim();
        const description = document
          .getElementById("newCodeDescription")
          .value.trim();

        if (!label || !code) {
          const errorElement = document.getElementById("addCodeError");
          const errorMessage = document.getElementById("addCodeErrorMessage");
          errorMessage.textContent = "코드 이름과 코드 값은 필수입니다.";
          errorElement.classList.remove("hidden");
          return;
        }

        // Validate code format (uppercase letters and underscores only)
        if (!/^[A-Z_]+$/.test(code)) {
          const errorElement = document.getElementById("addCodeError");
          const errorMessage = document.getElementById("addCodeErrorMessage");
          errorMessage.textContent =
            "코드 값은 영문 대문자와 언더스코어(_)만 사용할 수 있습니다.";
          errorElement.classList.remove("hidden");
          return;
        }

        try {
          // TODO: API Call - POST /common-codes
          // const response = await fetch('/api/common-codes', {
          //   method: 'POST',
          //   headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify({
          //     group_code: currentAddCodeType,
          //     code: code,
          //     label: label,
          //     description: description
          //   })
          // });
          //
          // if (!response.ok) {
          //   throw new Error('Failed to create code');
          // }

          // Simulate API call
          await new Promise((resolve) => setTimeout(resolve, 500));

          // Add to local data
          const newCode = { code, label, description };
          commonCodes[currentAddCodeType].push(newCode);

          // Select the new code
          if (currentAddCodeType === "BUSINESS_TYPE") {
            businessTypeahead.select(code);
          } else if (currentAddCodeType === "ERROR_CODE") {
            errorCodeTypeahead.select(code);
          }

          // Close modal
          document.getElementById("addCodeModal").classList.add("hidden");
          showToast("새 코드가 추가되었습니다.", "success");
        } catch (error) {
          console.error("Error creating code:", error);
          const errorElement = document.getElementById("addCodeError");
          const errorMessage = document.getElementById("addCodeErrorMessage");
          errorMessage.textContent =
            "코드 생성에 실패했습니다. 다시 시도해주세요.";
          errorElement.classList.remove("hidden");
        }
      }

      // Reset Form
      function resetForm() {
        document.getElementById("consultationForm").reset();
        businessTypeahead.reset();
        errorCodeTypeahead.reset();
        selectedBusinessType = null;
        selectedErrorCode = null;
        metadataFields = [];
        renderMetadataFields();

        // Clear all errors
        document.querySelectorAll(".form-error").forEach((error) => {
          error.classList.add("hidden");
        });
        document
          .querySelectorAll(".form-input, .form-textarea")
          .forEach((input) => {
            input.classList.remove("error");
          });
      }

      // Toast Notification
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icon =
          type === "success"
            ? '<svg class="toast-icon" fill="none" stroke="#2E7D32" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
            : '<svg class="toast-icon" fill="none" stroke="#C62828" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';

        toast.innerHTML = `
        ${icon}
        <div class="toast-message">${message}</div>
      `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Event Listeners
      document
        .getElementById("consultationForm")
        .addEventListener("submit", handleSubmit);
      document
        .getElementById("addMetadataBtn")
        .addEventListener("click", addMetadataField);
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (confirm("작성 중인 내용이 있습니다. 정말 취소하시겠습니까?")) {
          resetForm();
        }
      });

      // Manual Modal
      document.getElementById("manualModalNo").addEventListener("click", () => {
        document.getElementById("createManualModal").classList.add("hidden");
        resetForm();
      });

      document
        .getElementById("manualModalYes")
        .addEventListener("click", () => {
          // TODO: Navigate to manual creation page with consultation data
          // window.location.href = `/manuals/create?consultationId=${savedConsultationId}`;

          document.getElementById("createManualModal").classList.add("hidden");
          showToast("메뉴얼 생성 페이지로 이동합니다.", "success");
          setTimeout(() => {
            resetForm();
          }, 500);
        });

      // Add Code Modal
      document
        .getElementById("addCodeModalCancel")
        .addEventListener("click", () => {
          document.getElementById("addCodeModal").classList.add("hidden");
        });

      document
        .getElementById("addCodeModalSave")
        .addEventListener("click", handleAddCode);

      // Close modals on overlay click
      document
        .getElementById("createManualModal")
        .addEventListener("click", (e) => {
          if (e.target.id === "createManualModal") {
            document
              .getElementById("createManualModal")
              .classList.add("hidden");
            resetForm();
          }
        });

      document.getElementById("addCodeModal").addEventListener("click", (e) => {
        if (e.target.id === "addCodeModal") {
          document.getElementById("addCodeModal").classList.add("hidden");
        }
      });

      // Element SDK Integration
      async function onConfigChange(newConfig) {
        document.getElementById("headerTitle").textContent =
          newConfig.system_title || defaultConfig.system_title;
        document.getElementById("headerUserName").textContent =
          newConfig.user_name || defaultConfig.user_name;
        document.getElementById("headerDepartment").textContent =
          newConfig.department || defaultConfig.department;
        document.getElementById("pageTitle").textContent =
          newConfig.page_title || defaultConfig.page_title;
      }

      function mapToCapabilities(config) {
        return {
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined,
        };
      }

      function mapToEditPanelValues(config) {
        return new Map([
          ["system_title", config.system_title || defaultConfig.system_title],
          ["page_title", config.page_title || defaultConfig.page_title],
          ["user_name", config.user_name || defaultConfig.user_name],
          ["department", config.department || defaultConfig.department],
        ]);
      }

      // Initialize SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: onConfigChange,
          mapToCapabilities: mapToCapabilities,
          mapToEditPanelValues: mapToEditPanelValues,
        });

        config = window.elementSdk.config;
        onConfigChange(config);
      }

      // Add spin animation for loading state
      const style = document.createElement("style");
      style.textContent = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
      document.head.appendChild(style);
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9ab1fea19611ea25',t:'MTc2NTI1NzAxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
